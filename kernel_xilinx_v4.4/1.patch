diff --git a/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.c b/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.c
index bd9bd76..d1c3b77 100755
--- a/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.c
+++ b/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.c
@@ -32,6 +32,46 @@ UINT16 m_adc_target_3 = 0;
 UINT16 m_power_0P5dB_adc_3 = 0;
 UINT32 g_power_adc_word = 0;
 #endif
+static unsigned char crc8_table[] = {
+    0x00, 0x3e, 0x7c, 0x42, 0xf8, 0xc6, 0x84, 0xba, 0x95, 0xab, 0xe9, 0xd7,
+    0x6d, 0x53, 0x11, 0x2f, 0x4f, 0x71, 0x33, 0x0d, 0xb7, 0x89, 0xcb, 0xf5,
+    0xda, 0xe4, 0xa6, 0x98, 0x22, 0x1c, 0x5e, 0x60, 0x9e, 0xa0, 0xe2, 0xdc,
+    0x66, 0x58, 0x1a, 0x24, 0x0b, 0x35, 0x77, 0x49, 0xf3, 0xcd, 0x8f, 0xb1,
+    0xd1, 0xef, 0xad, 0x93, 0x29, 0x17, 0x55, 0x6b, 0x44, 0x7a, 0x38, 0x06,
+    0xbc, 0x82, 0xc0, 0xfe, 0x59, 0x67, 0x25, 0x1b, 0xa1, 0x9f, 0xdd, 0xe3,
+    0xcc, 0xf2, 0xb0, 0x8e, 0x34, 0x0a, 0x48, 0x76, 0x16, 0x28, 0x6a, 0x54,
+    0xee, 0xd0, 0x92, 0xac, 0x83, 0xbd, 0xff, 0xc1, 0x7b, 0x45, 0x07, 0x39,
+    0xc7, 0xf9, 0xbb, 0x85, 0x3f, 0x01, 0x43, 0x7d, 0x52, 0x6c, 0x2e, 0x10,
+    0xaa, 0x94, 0xd6, 0xe8, 0x88, 0xb6, 0xf4, 0xca, 0x70, 0x4e, 0x0c, 0x32,
+    0x1d, 0x23, 0x61, 0x5f, 0xe5, 0xdb, 0x99, 0xa7, 0xb2, 0x8c, 0xce, 0xf0,
+    0x4a, 0x74, 0x36, 0x08, 0x27, 0x19, 0x5b, 0x65, 0xdf, 0xe1, 0xa3, 0x9d,
+    0xfd, 0xc3, 0x81, 0xbf, 0x05, 0x3b, 0x79, 0x47, 0x68, 0x56, 0x14, 0x2a,
+    0x90, 0xae, 0xec, 0xd2, 0x2c, 0x12, 0x50, 0x6e, 0xd4, 0xea, 0xa8, 0x96,
+    0xb9, 0x87, 0xc5, 0xfb, 0x41, 0x7f, 0x3d, 0x03, 0x63, 0x5d, 0x1f, 0x21,
+    0x9b, 0xa5, 0xe7, 0xd9, 0xf6, 0xc8, 0x8a, 0xb4, 0x0e, 0x30, 0x72, 0x4c,
+    0xeb, 0xd5, 0x97, 0xa9, 0x13, 0x2d, 0x6f, 0x51, 0x7e, 0x40, 0x02, 0x3c,
+    0x86, 0xb8, 0xfa, 0xc4, 0xa4, 0x9a, 0xd8, 0xe6, 0x5c, 0x62, 0x20, 0x1e,
+    0x31, 0x0f, 0x4d, 0x73, 0xc9, 0xf7, 0xb5, 0x8b, 0x75, 0x4b, 0x09, 0x37,
+    0x8d, 0xb3, 0xf1, 0xcf, 0xe0, 0xde, 0x9c, 0xa2, 0x18, 0x26, 0x64, 0x5a,
+    0x3a, 0x04, 0x46, 0x78, 0xc2, 0xfc, 0xbe, 0x80, 0xaf, 0x91, 0xd3, 0xed,
+    0x57, 0x69, 0x2b, 0x15
+};
+
+static unsigned char crc8_checksum(unsigned char * data, int len)
+{
+        unsigned char crc = 0;
+        unsigned char *end;
+
+        if (len == 0)
+                return crc;
+        crc ^= 0xff;
+        end = data + len;
+        do {
+                crc = crc8_table[crc ^ *data++];
+        } while (data < end);
+
+        return crc ^ 0xff;
+}
 
 void cfg_adspi_readVadc(void)
 {
@@ -45,7 +85,7 @@ int transform_data_from_eeprom(unsigned char *buffer)
 {
 	int i = 0, j = 0, x = 0, txlen = 0, rxlen = 0;
 	unsigned char *fre_ptr = NULL;
-
+	unsigned char crc1,crc2;
 	calib_table.band_flag = buffer[i++];
 	printk(KERN_ALERT "band_flag:0x%x \n", calib_table.band_flag);
 	calib_table.cal_flag = buffer[i++];
@@ -154,6 +194,20 @@ int transform_data_from_eeprom(unsigned char *buffer)
 		}
 	}
 	i += rxlen;
+	
+	if(buffer[i] + buffer[i+1] == 0xff)
+	{
+		crc1 = crc8_checksum(buffer,i);
+		crc2 = ~crc1;
+		if(buffer[i]==crc1 && buffer[i+1] == crc2) {
+			printk(KERN_ALERT"calib_data: check sum successful(%02x,%02x)!\r\n",crc1,crc2);
+		} else {
+			printk(KERN_ALERT"calib_data: check sum error(%02x,%02x)!\r\n",crc1,crc2);
+			return -1;
+		}
+	} else {
+		printk(KERN_ALERT"calib_data:no check sum!\r\n");
+	}
 	return 0;
 }
 
@@ -667,6 +721,7 @@ void rf_init_target_adc(UINT16 freq, UINT16 target_power)
 }
 
 extern UINT32 tracp_loop;
+extern UINT8 rf_ant_num;
 int rf_power_track_loop_4ant(void)
 {
 	UINT16 power_adc_H = 0, power_adc_L = 0;
@@ -674,97 +729,64 @@ int rf_power_track_loop_4ant(void)
 	UINT16	adjust_flag1 = 1,adjust_flag0 = 1,adjust_flag2 = 1,adjust_flag3 = 1;
 	INT32 index0 = 0, index1 = 0,index2 = 0, index3 = 0;
 	INT32  ret = 0;
+	int val = 0;
 	UINT32 VADC0=0,VADC1=0,VADC2=0,VADC3=0;
-	TXRX_GAIN TxPowValue={0};	
-	VADC0=NST_IO_READ32(RF_VADC0_ADDR);
-	#ifndef DEAL_DATA_HW
-	VADC1=NST_IO_READ32(RF_VADC1_ADDR);	
-	if(four_ant_enable) {
-	VADC2=NST_IO_READ32(RF_VADC2_ADDR);
-	VADC3=NST_IO_READ32(RF_VADC3_ADDR);
+	TXRX_GAIN TxPowValue={0};
+	unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
+	if(rf_ant_num == 1) {
+		VADC0=NST_IO_READ32(RF_VADC0_ADDR);
+	}else if(rf_ant_num == 2) {
+		VADC0=NST_IO_READ32(RF_VADC0_ADDR);
+		VADC1=NST_IO_READ32(RF_VADC2_ADDR);
+	}else if (rf_ant_num == 4) {
+		VADC0=NST_IO_READ32(RF_VADC0_ADDR);
+		VADC1=NST_IO_READ32(RF_VADC1_ADDR);
+		VADC2=NST_IO_READ32(RF_VADC2_ADDR);
+		VADC3=NST_IO_READ32(RF_VADC3_ADDR);
 	}
-	#endif
+	
 	power_adc_0 = VADC0&0xFFFF;
-	#ifndef DEAL_DATA_HW
-	power_adc_1 = VADC1&0xFFFF;
-	if(four_ant_enable) {
-	power_adc_2 = VADC2&0xFFFF;
-	power_adc_3 = VADC3&0xFFFF;
+	if(rf_ant_num == 2) {
+		power_adc_1 = VADC1&0xFFFF;
 	}
-   #endif
-	#ifndef DEAL_DATA_HW
-	/* check adc in valid range: if adc value less than 200, indicate mal-function of tx path*/
-	if((power_adc_0 < ADC_LOW_LIMIT || power_adc_0 > ADC_HIGH_LIMIT)
-		|| (power_adc_1 < ADC_LOW_LIMIT || power_adc_1 > ADC_HIGH_LIMIT))
-	{
-		if(four_ant_enable) {
-			if((power_adc_2 < ADC_LOW_LIMIT || power_adc_2 > ADC_HIGH_LIMIT)
-			||(power_adc_3 < ADC_LOW_LIMIT || power_adc_3 > ADC_HIGH_LIMIT)){ 
-				return 0;
-			}
-		}
+	if(rf_ant_num == 4) {
+		power_adc_2 = VADC2&0xFFFF;
+		power_adc_3 = VADC3&0xFFFF;
+	}
+	if (power_adc_0 < ADC_LOW_LIMIT || power_adc_0 > ADC_HIGH_LIMIT) {
 		return 0;
 	}
-	#else
-	if(power_adc_0 < ADC_LOW_LIMIT || power_adc_0 > ADC_HIGH_LIMIT)
-	return 0;
-	#endif
+	if(rf_ant_num == 2) {
+		if (power_adc_1 < ADC_LOW_LIMIT || power_adc_1 > ADC_HIGH_LIMIT) 
+			return 0;
+	}
+	if(rf_ant_num == 4) {
+		if((power_adc_2 < ADC_LOW_LIMIT || power_adc_2 > ADC_HIGH_LIMIT)
+		||(power_adc_3 < ADC_LOW_LIMIT || power_adc_3 > ADC_HIGH_LIMIT))
+			return 0;
+	}
 	if(m_control_loop_enable == 0)
 	{
 		return 0;
 	}
-	#ifndef DEAL_DATA_HW
+#ifndef DEAL_DATA_HW
 	TxPowValue.Word= NST_IO_READ32(ADDR_TX_POWER_CALUSE);
-	#else
-	{
-		unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
-		Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
-		Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
-		TxPowValue.Bit.Gain0 = (Tx_0_1 >>8)&0xff;
-		TxPowValue.Bit.Gain1 = (Tx_0_1 >>24)&0xff;	
-		TxPowValue.Bit.Gain2 = (Tx_2_3 >>8)&0xff;
-		TxPowValue.Bit.Gain3 = (Tx_2_3 >>24)&0xff;
-	}
-	#endif
+#else
+	Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+	Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
+	TxPowValue.Bit.Gain0 = (Tx_0_1 >>8)&0xff;
+	TxPowValue.Bit.Gain1 = (Tx_0_1 >>24)&0xff;	
+	TxPowValue.Bit.Gain2 = (Tx_2_3 >>8)&0xff;
+	TxPowValue.Bit.Gain3 = (Tx_2_3 >>24)&0xff;
+#endif
 	index0 = rf9808_powerword2index(TxPowValue.Bit.Gain0);
-	#ifndef DEAL_DATA_HW
-	index1 = rf9808_powerword2index(TxPowValue.Bit.Gain1);
-	if(four_ant_enable) {
-	index2 = rf9808_powerword2index(TxPowValue.Bit.Gain2);
-	index3 = rf9808_powerword2index(TxPowValue.Bit.Gain3);
-	}
-	#endif
-#ifdef DEAL_DATA_HW
-		if(power_adc_0 + m_power_0P5dB_adc_0 < m_adc_target_0)
-		{
-			index0 += 1;
-		}
-		else if(power_adc_0 - m_power_0P5dB_adc_0 > m_adc_target_0)
-		{
-			index0 -= 1;
+	if(rf_ant_num > 1) {
+		index1 = rf9808_powerword2index(TxPowValue.Bit.Gain1);
+		if(rf_ant_num == 4) {
+			index2 = rf9808_powerword2index(TxPowValue.Bit.Gain2);
+			index3 = rf9808_powerword2index(TxPowValue.Bit.Gain3);
 		}
-		else
-		{
-			adjust_flag0 = 0;
-		}
-#else
-	/* adjust 1dB if needed */
-	if(power_adc_1 + m_power_0P5dB_adc_1 < m_adc_target_1)
-	{
-		index1 += 1;
-		//printk("+1power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
 	}
-	else if(power_adc_1 - m_power_0P5dB_adc_1 > m_adc_target_1)
-	{
-		index1 -= 1;
-		//printk("-1power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
-	}
-	else
-	{
-		adjust_flag1 = 0;
-		//printk("0power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
-	}
-	
 	if(power_adc_0 + m_power_0P5dB_adc_0 < m_adc_target_0)
 	{
 		index0 += 1;
@@ -777,55 +799,52 @@ int rf_power_track_loop_4ant(void)
 	{
 		adjust_flag0 = 0;
 	}
-	if(four_ant_enable) {
-	if(power_adc_2 + m_power_0P5dB_adc_2 < m_adc_target_2)
-	{
-		index2 += 1;
-	}
-	else if(power_adc_2 - m_power_0P5dB_adc_2 > m_adc_target_2)
-	{
-		index2 -= 1;
-	}
-	else
-	{
-		adjust_flag2 = 0;
-	}
-	
-	if(power_adc_3 + m_power_0P5dB_adc_3 < m_adc_target_3)
-	{
-		index3 += 1;
-	}
-	else if(power_adc_3 - m_power_0P5dB_adc_3 > m_adc_target_3)
-	{
-		index3 -= 1;
-	}
-	else
-	{
-		adjust_flag3 = 0;
-	}
+	if(rf_ant_num > 1) {
+		/* adjust 1dB if needed */
+		if(power_adc_1 + m_power_0P5dB_adc_1 < m_adc_target_1)
+		{
+			index1 += 1;
+			//printk("+1power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
+		}
+		else if(power_adc_1 - m_power_0P5dB_adc_1 > m_adc_target_1)
+		{
+			index1 -= 1;
+			//printk("-1power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
+		}
+		else
+		{
+			adjust_flag1 = 0;
+			//printk("0power_adc_1:%u,m_power_0P5dB_adc_1:%u,m_adc_target_1:%u\n",power_adc_1,m_power_0P5dB_adc_1,m_adc_target_1);
+		}
+		if (rf_ant_num == 4) {
+			if(power_adc_2 + m_power_0P5dB_adc_2 < m_adc_target_2)
+			{
+				index2 += 1;
+			}
+			else if(power_adc_2 - m_power_0P5dB_adc_2 > m_adc_target_2)
+			{
+				index2 -= 1;
+			}
+			else
+			{
+				adjust_flag2 = 0;
+			}
+			
+			if(power_adc_3 + m_power_0P5dB_adc_3 < m_adc_target_3)
+			{
+				index3 += 1;
+			}
+			else if(power_adc_3 - m_power_0P5dB_adc_3 > m_adc_target_3)
+			{
+				index3 -= 1;
+			}
+			else
+			{
+				adjust_flag3 = 0;
+			}
+		}
 	}
-	#endif
 
-	
-#ifdef DEAL_DATA_HW
-if(index0 >= TXGAINSIZE-1)
-	{
-		index0 = TXGAINSIZE-1;
-	}
-	else if(index0 < 0)
-	{
-		index0 = 0;
-	}
-#else
-	/* check index in valid range */
-	if(index1 >= TXGAINSIZE-1)
-	{
-		index1 = TXGAINSIZE-1;
-	}
-	else if(index1 < 0)
-	{
-		index1 = 0;
-	}
 	if(index0 >= TXGAINSIZE-1)
 	{
 		index0 = TXGAINSIZE-1;
@@ -834,90 +853,82 @@ if(index0 >= TXGAINSIZE-1)
 	{
 		index0 = 0;
 	}
-	if(four_ant_enable) {
-	    if(index2 >= TXGAINSIZE-1)
-	    {
-			index2 = TXGAINSIZE-1;
-	    }
-		else if(index2 < 0)
+	if(rf_ant_num > 1) {
+		/* check index in valid range */
+		if(index1 >= TXGAINSIZE-1)
+		{
+			index1 = TXGAINSIZE-1;
+		}
+		else if(index1 < 0)
+		{
+			index1 = 0;
+		}
+		if(index0 >= TXGAINSIZE-1)
 		{
-			index2 = 0;
+			index0 = TXGAINSIZE-1;
+		}
+		else if(index0 < 0)
+		{
+			index0 = 0;
+		}
+		if(rf_ant_num == 4) {
+		    if(index2 >= TXGAINSIZE-1)
+		    {
+				index2 = TXGAINSIZE-1;
+		    }
+			else if(index2 < 0)
+			{
+				index2 = 0;
+			}
+			 if(index3 >= TXGAINSIZE-1)
+			 {
+				index3 = TXGAINSIZE-1;
+			 }
+			 else if(index3 < 0)
+			 {
+				index3 = 0;
+			 }
 		}
-		 if(index3 >= TXGAINSIZE-1)
-		 {
-			index3 = TXGAINSIZE-1;
-		 }
-		 else if(index3 < 0)
-		 {
-			index3 = 0;
-		 }
 	}
-	#endif
-	if(four_ant_enable) {
-	if(adjust_flag0 + adjust_flag1 + adjust_flag2 + adjust_flag3 > 0)
-	{
+	if(rf_ant_num == 4) {
+		val = adjust_flag0 + adjust_flag1 + adjust_flag2 + adjust_flag3;
+	}else if(rf_ant_num == 2) {
+		val = adjust_flag0 + adjust_flag1;
+	}else if(rf_ant_num == 1) {
+		val = adjust_flag0 ;
+	}
+	if(val > 0) {
 		/* assure use latest status of MAC_CTRL0_ADDR */
 		TxPowValue.Bit.Gain0 = rf9808_Index2PowerWordsta(index0);
-		TxPowValue.Bit.Gain1 = rf9808_Index2PowerWordsta(index1);
-		TxPowValue.Bit.Gain2 = rf9808_Index2PowerWordsta(index2);
-		TxPowValue.Bit.Gain3 = rf9808_Index2PowerWordsta(index3);
-		#ifndef DEAL_DATA_HW
-		NST_IO_WRITE32((ADDR_TX_POWER_CALUSE), (TxPowValue.Word));
-		#else
-		{
-			unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
-			Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
-			Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
-			Tx_0_1 &= (~(0xFF<<8));
-			Tx_0_1 &= (~(0xFF<<24));
-			Tx_2_3 &= (~(0xFF<<8));
-			Tx_2_3 &= (~(0xFF<<24));
-			Tx_0_1 |= (TxPowValue.Bit.Gain0 <<8);
-			Tx_0_1 |= (TxPowValue.Bit.Gain1 << 24);
-			Tx_2_3 |= (TxPowValue.Bit.Gain2 <<8);
-			Tx_2_3 |= (TxPowValue.Bit.Gain3 << 24);
-			NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);
-			NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Tx_2_3);
+		if (rf_ant_num == 2)
+			TxPowValue.Bit.Gain1 = rf9808_Index2PowerWordsta(index1);
+		if (rf_ant_num == 4) {
+			TxPowValue.Bit.Gain2 = rf9808_Index2PowerWordsta(index2);
+			TxPowValue.Bit.Gain3 = rf9808_Index2PowerWordsta(index3);
 		}
-		#endif
+#ifndef DEAL_DATA_HW
+		NST_IO_WRITE32((ADDR_TX_POWER_CALUSE), (TxPowValue.Word));
+#else
+		unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
+		Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+		Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
+		Tx_0_1 &= (~(0xFF<<8));
+		Tx_0_1 &= (~(0xFF<<24));
+		Tx_2_3 &= (~(0xFF<<8));
+		Tx_2_3 &= (~(0xFF<<24));
+		Tx_0_1 |= (TxPowValue.Bit.Gain0 <<8);
+		Tx_0_1 |= (TxPowValue.Bit.Gain1 << 24);
+		Tx_2_3 |= (TxPowValue.Bit.Gain2 <<8);
+		Tx_2_3 |= (TxPowValue.Bit.Gain3 << 24);
+		NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);
+		NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Tx_2_3);
+#endif		
 		ret = 1;
 		debug_adc_Powindex0 = index0;
 		debug_adc_Powindex1 = index1;
 		debug_adc_Powindex2 = index2;
 		debug_adc_Powindex3 = index3;
-        //printk("after change index:0:%u,1:%u,2:%u,3:%u\n");
-	}
-	}else {
-		#ifndef DEAL_DATA_HW
-		if(adjust_flag0 + adjust_flag1 > 0)
-		#else 
-		if(adjust_flag0 > 0)
-		#endif			
-		{
-			//printk("index0:%d,1:%d \n",index0,index1);
-			/* assure use latest status of MAC_CTRL0_ADDR */
-			TxPowValue.Bit.Gain0 = rf9808_Index2PowerWordsta(index0);
-			TxPowValue.Bit.Gain1 = rf9808_Index2PowerWordsta(index1);
-		{
-			unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
-			Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
-			Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
-			Tx_0_1 &= (~(0xFF<<8));
-			Tx_0_1 &= (~(0xFF<<24));
-
-			Tx_0_1 |= (TxPowValue.Bit.Gain0 <<8);
-			//Tx_0_1 |= (TxPowValue.Bit.Gain1 << 24);
-			//Tx_2_3 |= (TxPowValue.Bit.Gain2 <<8);
-			//Tx_2_3 |= (TxPowValue.Bit.Gain3 << 24);
-			NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);
-		}
-			ret = 1;
-			debug_adc_Powindex0 = index0;
-			debug_adc_Powindex1 = index1;
-	        //printk("after change index:0:%u,1:%u,2:%u,3:%u\n");
-		}
-	}
-			
+	}		
 	return ret;
 }
 #endif
diff --git a/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.h b/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.h
index 0aa2aaa..fd152e4 100755
--- a/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.h
+++ b/drivers/net/wireless/nufront/euht_sta/bsp/eeprom.h
@@ -24,7 +24,7 @@
 
 #define PRECISION3 (1)
 #define STACAL_VALUE_NUM  100
-#ifdef STA_VADC_2ANT //STA_CAL
+#if(ANT_NUM == 2)
 #define RF_VADC0_ADDR     0xC4
 #define RF_VADC1_ADDR	   0xCC
 #define RF_VADC2_ADDR     0xC8
diff --git a/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.c b/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.c
index b9d2639..000c51f 100755
--- a/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.c
+++ b/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.c
@@ -743,7 +743,7 @@ void rf8816_change_chbw(UINT32 BW_cfg, UINT32 isFirstTime, UINT32 chid)
 	static UINT32 mac_bw = 0;
 
 	/*********************************************/
-	/*      Step3: set SHDN¬°¬¢TXON¬°¬¢RXON=100  */
+	/*      Step3: set SHDN?Ôø†TXON?Ôø†RXON=100  */
 	/********************************************/
 	//rf_mode_cfg(SHDN_TX_RX100, STA_MODE);
 
@@ -1064,3 +1064,18 @@ int rf9808_reg_rd_factory_test(void)
 
 	return reg_val;
 }
+
+#define MAX_ANT_NUM 4
+unsigned int spi_how_many_ant(void)
+{
+	unsigned int i,ant_num = 0,val;
+	for(i = 0; i < MAX_ANT_NUM; i++) {
+		val = spi_read(0, i);
+		if(val ==  0x6803){      //CW0 ,ÁâàÊú¨Âè∑Ôºå9808,8816Á≠âÈÉΩ‰∏ÄÊ†∑ 
+			ant_num++;
+			printk(KERN_ALERT"ant%u cw0:%x\n\r", i,val);
+		}
+	}	
+	return ant_num;
+}
+
diff --git a/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.h b/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.h
index abd4fa2..77e3a41 100755
--- a/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.h
+++ b/drivers/net/wireless/nufront/euht_sta/bsp/rf9808.h
@@ -425,6 +425,7 @@ INT32 rf9808_powerword2index(UINT8 pWord);
 void rf9808_dump_spi_reg(void);
 int rf9808_reg_rd_factory_test(void);
 int rf_reg_info_show(struct seq_file *seq, void *v);
+unsigned int spi_how_many_ant(void);
 
 extern UINT32 rf_reg_rd_test;
 extern UINT32 rf_ch_delay_us ;/*us*/
diff --git a/drivers/net/wireless/nufront/euht_sta/core/core.c b/drivers/net/wireless/nufront/euht_sta/core/core.c
index ddf9db0..77d41e3 100755
--- a/drivers/net/wireless/nufront/euht_sta/core/core.c
+++ b/drivers/net/wireless/nufront/euht_sta/core/core.c
@@ -61,10 +61,12 @@ extern void cfg_adspi_readVadc ( void );
 void AuthInit(void);
 void Cap_AuthInit(void);
 
+UINT8 rf_ant_num = 0;
+
 INT32 main(void)
 {
 	INT32 ret = 1;
-
+	
 	printk(KERN_ALERT "\n\n\n\n\n");
 	printk(KERN_ALERT "==========================================\n");
 	printk(KERN_ALERT "=      (C) Copyright, 2016, Nufront      =\n");
@@ -185,7 +187,9 @@ INT32 main(void)
 	schedule_mgmt_work();
 	printk(KERN_ALERT "=======sta schedule mgmt end=======\n");
 #else
+	rf_ant_num = spi_how_many_ant();
 	printk(KERN_ALERT "==================sta cal 2018.11.20======================\n");
+	printk(KERN_ALERT "====================ANT_NUM:%d====================\n",rf_ant_num);
 #endif
 	return ret;
 }
diff --git a/drivers/net/wireless/nufront/euht_sta/core/features.h b/drivers/net/wireless/nufront/euht_sta/core/features.h
index 81249aa..c0c99dc 100755
--- a/drivers/net/wireless/nufront/euht_sta/core/features.h
+++ b/drivers/net/wireless/nufront/euht_sta/core/features.h
@@ -14,7 +14,7 @@
 /************sta_cal*************/
 #define STA_CAL 
 #define DEAL_DATA_HW //for cal.
-//#define STA_VADC_2ANT //ADC sta 
+#define ANT_NUM   4  //1,2,4
 
 /*******************************/
 /* #define CMD_FROM_DRIVER */
diff --git a/drivers/net/wireless/nufront/euht_sta/sta_cal/nufront_sta_debug_schdule_buf.c b/drivers/net/wireless/nufront/euht_sta/sta_cal/nufront_sta_debug_schdule_buf.c
index 7f17611..d9fcc41 100755
--- a/drivers/net/wireless/nufront/euht_sta/sta_cal/nufront_sta_debug_schdule_buf.c
+++ b/drivers/net/wireless/nufront/euht_sta/sta_cal/nufront_sta_debug_schdule_buf.c
@@ -97,6 +97,7 @@ UINT8 g_localbw = 80;
 UINT8 cal_mcs = 1;
 UINT8 rx_pass = 0; //record current rx pass
 UINT8 is_agc_mode = 1;//ƒ¨»œ≤ª÷ß≥÷∏°µ„ ˝µƒ’˝≥£∞Ê±æ
+extern UINT8 rf_ant_num;
 
 static UINT32 rece_tmp; //record the last framenum
 
@@ -117,7 +118,7 @@ const unsigned char TX_GAIN_TABLE_FOR_CAL[52] = {
 0x5 ,0xD ,0x15,0x1D,0x2 ,0xA ,0x12,0x1A,0x22,0x2A,
 0x32,0x3A,0x6 ,0xE ,0x16,0x1E,0x3 ,0xB ,0x13,0x1B,
 0x23,0x2B,0x33,0x3B,0x7 ,0xF ,0x17,0x1F,0x27,0x2F,
-0x37,0x3F 
+0x37,0x3F
 };
 const unsigned char RX_GAIN_TABLE_FOR_CAL[50]={
 0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,
@@ -175,13 +176,13 @@ typedef struct nufront_ioctl_args{
 void close_pa(void)
 {
 	UINT32 Mask_rf_0_1 = 0,Mask_rf_2_3 = 0;
-	Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04); 		
+	Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 	Mask_rf_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 	Mask_rf_0_1 &= (~0xFF);// RF 0
 	Mask_rf_0_1 &= (~(0xFF<<16));//RF 1
 	Mask_rf_2_3 &= (~0xFF);//RF 2
 	Mask_rf_2_3 &= (~(0xFF<<16));//RF 3
-	CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Mask_rf_0_1);			
+	CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Mask_rf_0_1);
 	CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Mask_rf_2_3);
 
 }
@@ -196,7 +197,6 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 	int step=0;
 	unsigned int LnaValue = 0;
 	UINT32 VADC_H=0,VADC_L=0;
-	UINT16 Ain0=0,Ain1=0,Ain2=0,Ain3=0;
 	UINT32 RxLnaInit=0;
 	UINT8   highLna=0,midLna=0;
 	UINT8   gain_ant[4]={0};
@@ -216,10 +216,10 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 	//printk("cmd=%d\n", cmd);
 	err = copy_from_user(parg,(void __user *)arg,sizeof(struct nufront_ioctl_args));
 	if(err){
-		printk("%s : copy the ioctl from user failed %d\n",__func__,err);	
+		printk("%s : copy the ioctl from user failed %d\n",__func__,err);
 		goto out;
 	}
-	
+
 	//printk("nufront_dbg_unlocked_ioctl\n");
 	switch(cmd)
     	{
@@ -234,13 +234,13 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			{
 				g_struCalPara.b_UseCalResult = 0;
 				printk("\r\n Txreg and index for golden =%d\r\n",g_struCalPara.b_UseCalResult);
-			} 
+			}
 			if(1==g_struCalPara.b_UseCalResult)
 			{
 			   printk("\r\nGoldenSTA enable=%d,which is volte ane power \r\n",g_struCalPara.b_UseCalResult);
 			}
-		
-			break; 
+
+			break;
 		}
 		case IOCTRL_RXGAIN_LEVEL:
 		{
@@ -284,7 +284,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 						}
 					}
 				}
-			}			
+			}
 			printk("Lna level:%d,LnaReg:0x%08x\r\n",parg->LNA_level,CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x20));
 			break;
 		}
@@ -292,7 +292,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 		{
 		   if(g_readFlashOK)
 		   	{
-		   	
+
 				if(g_struCalPara.b_UseCalResult==0)
 				{
 					tx_reg_index = (parg->Txpower)*2+6;
@@ -309,7 +309,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 					#else
 					{
 						unsigned int Tx_0_1 = 0,Tx_2_3 = 0;
-						Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+						Tx_0_1 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 						Tx_2_3 = NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 						Tx_0_1 &= (~(0xFF<<8));
 						Tx_0_1 &= (~(0xFF<<24));
@@ -338,7 +338,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 					#ifdef DEAL_DATA_HW
 					{
 						UINT32 Tx_0_1 = 0,Tx_2_3 = 0;
-						Tx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+						Tx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 						Tx_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 						Tx_0_1 &= (~(0xFF<<8));
 						Tx_0_1 &= (~(0xFF<<24));
@@ -351,9 +351,9 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 						CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);
 						if(four_ant_enable)
 						CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Tx_2_3);
-					}	
+					}
 					#else
-					CAL_NST_IO_WRITE32(ADDR_TX_POWER_CALUSE, (TxPowValue.Word));	
+					CAL_NST_IO_WRITE32(ADDR_TX_POWER_CALUSE, (TxPowValue.Word));
 					#endif
 					printk("Cal STA Target Freq:%d,TxPower=%ddbm,CurTxReg:0x%08x\n\r",g_localchild,parg->Txpower,CAL_NST_IO_READ32(ADDR_TX_POWER_CALUSE));
 				}
@@ -365,11 +365,11 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			break;
 		}
 		case  IOCTRL_TXREG:
-		{	
+		{
 			UINT8 *Tx_Reg = (UINT8 *)(&parg->TxReg);
 			UINT32 Tx_0_1 = 0,Tx_2_3 = 0;
 			#ifdef DEAL_DATA_HW
-			Tx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+			Tx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 			Tx_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 			Tx_0_1 &= (~(0xFF<<8));
 			Tx_0_1 &= (~(0xFF<<24));
@@ -379,35 +379,42 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			Tx_0_1 |= (Tx_Reg[1] << 24);
 			Tx_2_3 |= (Tx_Reg[2] <<8);
 			Tx_2_3 |= (Tx_Reg[3] << 24);
-			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);			
+			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Tx_0_1);
 			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Tx_2_3);
 			#else
 			CAL_NST_IO_WRITE32(ADDR_TX_POWER_CALUSE, (parg->TxReg));
 			printk("TxReg:0x%x,CurTxReg:0x%x\n\r",parg->TxReg,CAL_NST_IO_READ32(ADDR_TX_POWER_CALUSE));
 			#endif
-			printk("TxReg_01:0x%x,TxReg_23:0x%x\n\r",Tx_0_1,Tx_2_3);	
+			printk("TxReg_01:0x%x,TxReg_23:0x%x\n\r",Tx_0_1,Tx_2_3);
 			break;
 		}
 		case IOCTRL_GETVADC:
 		{
-			parg->vadc0 =  CAL_NST_IO_READ32(RF_VADC0_ADDR)&0xFFFF;
-			parg->vadc1 =  CAL_NST_IO_READ32(RF_VADC1_ADDR)&0xFFFF;
-		    parg->vadc2 =  CAL_NST_IO_READ32(RF_VADC2_ADDR)&0xFFFF;
-			parg->vadc3 =  CAL_NST_IO_READ32(RF_VADC3_ADDR)&0xFFFF;
+			if(rf_ant_num == 2) {
+				parg->vadc0 =  CAL_NST_IO_READ32(RF_VADC0_ADDR)&0xFFFF;
+				parg->vadc1 =  CAL_NST_IO_READ32(RF_VADC2_ADDR)&0xFFFF;
+		   		parg->vadc2 =  CAL_NST_IO_READ32(RF_VADC1_ADDR)&0xFFFF;
+				parg->vadc3 =  CAL_NST_IO_READ32(RF_VADC3_ADDR)&0xFFFF;
+			}else {
+				parg->vadc0 =  CAL_NST_IO_READ32(RF_VADC0_ADDR)&0xFFFF;
+				parg->vadc1 =  CAL_NST_IO_READ32(RF_VADC1_ADDR)&0xFFFF;
+		   		parg->vadc2 =  CAL_NST_IO_READ32(RF_VADC2_ADDR)&0xFFFF;
+				parg->vadc3 =  CAL_NST_IO_READ32(RF_VADC3_ADDR)&0xFFFF;
+			}
 			break;
 		}
 		case IOCTRL_FREQ_CHILD:
 		{
-			#ifdef DEAL_DATA_HW			
-			close_pa();		
-			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable	
+			#ifdef DEAL_DATA_HW
+			close_pa();
+			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
 			#endif
 			#ifdef U_BAND
 			rf8816_change_chbw(parg->BandWidth, parg->Is5G, parg->Freq_child);
-			#else			
+			#else
 			rf9808_change_chbw(parg->BandWidth, parg->Is5G, parg->Freq_child);
 			#endif
-			g_localbw = parg->BandWidth;			
+			g_localbw = parg->BandWidth;
 			if(g_struCalPara.b_UseCalResult && g_readFlashOK) //◊˜Œ™golden ∞Â£¨µ˜’˚rxgain
 			{
 				set_rxgain_according_channel(parg->Freq_child,0);
@@ -419,9 +426,9 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 					}
 				}
 			}
-		
+
 			g_localchild = parg->Freq_child;
-			printk("FreqChild:%d\r\n",parg->Freq_child);			
+			printk("FreqChild:%d\r\n",parg->Freq_child);
 			break;
 		}
 		case IOCTRL_MEASURE_RESULT:
@@ -434,7 +441,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			}
 			if(g_struCalPara.ui_sicchNum!=0)
 			{
-				parg->Dper = ( g_struCalPara.ui_sicchNum - g_struCalPara.ui_CorDataFramNum)*100/g_struCalPara.ui_sicchNum;			
+				parg->Dper = ( g_struCalPara.ui_sicchNum - g_struCalPara.ui_CorDataFramNum)*100/g_struCalPara.ui_sicchNum;
 			}
 			if(g_struCalPara.ui_CorDataFramNum==0)
 			{
@@ -444,21 +451,20 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			{
 				parg->Dper = 100;
 			}else {
-
-				parg->Dper = (g_counter.FCSErrorCount)*100/(g_counter.FCSErrorCount+g_struCalPara.ui_CorDataFramNum);	
-			}			
+				parg->Dper = (g_counter.FCSErrorCount)*100/(g_counter.FCSErrorCount+g_struCalPara.ui_CorDataFramNum);
+			}
 			if(sta_platform_type == STA_PLATFORM_PLUS) {
-				parg->RegRssi[0] = g_struCalPara.c_rssi_reg[0]; 
-				parg->RegRssi[1] = g_struCalPara.c_rssi_reg[1]; 
-				parg->RegRssi[2] = g_struCalPara.c_rssi_reg[2]; 
-				parg->RegRssi[3] = g_struCalPara.c_rssi_reg[3]; 
+				parg->RegRssi[0] = g_struCalPara.c_rssi_reg[0];
+				parg->RegRssi[1] = g_struCalPara.c_rssi_reg[1];
+				parg->RegRssi[2] = g_struCalPara.c_rssi_reg[2];
+				parg->RegRssi[3] = g_struCalPara.c_rssi_reg[3];
 			}else {
-				parg->RegRssi[0] = g_struCalPara.c_rssi_reg[0]; 
-				parg->RegRssi[1] = g_struCalPara.c_rssi_reg[0]; 
-				parg->RegRssi[2] = g_struCalPara.c_rssi_reg[2]; 
-				parg->RegRssi[3] = g_struCalPara.c_rssi_reg[2]; 			
+				parg->RegRssi[0] = g_struCalPara.c_rssi_reg[0];
+				parg->RegRssi[1] = g_struCalPara.c_rssi_reg[0];
+				parg->RegRssi[2] = g_struCalPara.c_rssi_reg[2];
+				parg->RegRssi[3] = g_struCalPara.c_rssi_reg[2];
 			}
-			
+
 	        parg->averageRssi0 = g_struCalPara.i_rssi_average;
 			//parg->averageRssi1 = g_struCalPara.i_rssi_average1;
 			parg->SNR0 = (g_struCalPara.uc_snr0 -40) /4;
@@ -469,12 +475,6 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			parg->SentFrameNum = g_struCalPara.ui_SendPadNum;
 			parg->Fddseq=g_struCalPara.ui_Fddseq;
 			parg->IntTx = g_struCalPara.IntTx;
-			//VADC_H=CAL_NST_IO_READ32(RF_VADC0_ADDR);
-			//VADC_L=CAL_NST_IO_READ32(RF_VADC1_ADDR);
-			Ain0 = CAL_NST_IO_READ32(RF_VADC0_ADDR)&0xFFFF;
-            Ain1 = CAL_NST_IO_READ32(RF_VADC1_ADDR)&0xFFFF;
-			Ain2 = CAL_NST_IO_READ32(RF_VADC2_ADDR)&0xFFFF;		    
-			Ain3 = CAL_NST_IO_READ32(RF_VADC3_ADDR)&0xFFFF;
             {
 				parg->evm[0] = g_struCalPara.evm[0];
 				parg->evm[1] = g_struCalPara.evm[1];
@@ -490,21 +490,15 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			parg->sicchErroNum = g_struCalPara.ui_SichCchErrTotal;
 			parg->SicchNum = g_struCalPara.ui_sicchNum;
 			parg->RecFrameNum = g_struCalPara.ui_CorDataFramNum;
-			parg->SentFrameNum = g_struCalPara.ui_SendPadNum;
+			parg->SentFrameNum = 0;
 			parg->Fddseq=g_struCalPara.ui_Fddseq;
 			parg->IntTx = g_struCalPara.IntTx;
-			//VADC_H=CAL_NST_IO_READ32(RF_VADC0_ADDR);
-			//VADC_L=CAL_NST_IO_READ32(RF_VADC1_ADDR);
-			Ain0 = CAL_NST_IO_READ32(RF_VADC0_ADDR)&0xFFFF;
-            Ain1 = CAL_NST_IO_READ32(RF_VADC1_ADDR)&0xFFFF;
-			Ain2 = CAL_NST_IO_READ32(RF_VADC2_ADDR)&0xFFFF;		    
-			Ain3 = CAL_NST_IO_READ32(RF_VADC3_ADDR)&0xFFFF;
 			if(is_agc_mode)
             {
-				parg->RegRssi[0] = 0xba; 
-				parg->RegRssi[1] = 0xba; 
-				parg->RegRssi[2] = 0xba; 
-				parg->RegRssi[3] = 0xba; 
+				parg->RegRssi[0] = 0xba;
+				parg->RegRssi[1] = 0xba;
+				parg->RegRssi[2] = 0xba;
+				parg->RegRssi[3] = 0xba;
 				if(rx_pass < 4) {
 					parg->RegRssi[rx_pass] = g_struCalPara.c_rssi_reg[0];
 				}
@@ -519,21 +513,21 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				parg->rssi_float = rssi_float;
 				parg->RegRssi[0] = 0xba;
 				parg->RegRssi[1] = 0xba;
-				parg->RegRssi[2] = 0xba; 
-				parg->RegRssi[3] = 0xba; 
+				parg->RegRssi[2] = 0xba;
+				parg->RegRssi[3] = 0xba;
 				parg->evm[0] = 0;
 				parg->evm[1] = 0;
 				parg->evm[2] = 0;
 				parg->evm[3] = 0;
 				//  ’µΩµƒ÷° ˝
 				UINT32 recv_reg = (CAL_NST_IO_READ32(0x2b0)&0xffffff);
-				recv_num = recv_reg - rece_tmp;			
+				recv_num = recv_reg - rece_tmp;
 				if(recv_num < 0) {
 					recv_num= (0x1000000 - rece_tmp + recv_reg);
 				}
 				rece_tmp = recv_reg;
 				g_struCalPara.ui_CorDataFramNum += recv_num;
-				parg->RecFrameNum  = g_struCalPara.ui_CorDataFramNum;				
+				parg->RecFrameNum  = g_struCalPara.ui_CorDataFramNum;
 		    }
 #endif
 			break;
@@ -553,19 +547,19 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			g_struCalPara.ui_SichCchErrTotal = 0;
 			g_struCalPara.i_rssi_average =0;
 			g_struCalPara.i_rssi_average1 =0;
-			memset(g_struCalPara.evm,0,sizeof(g_struCalPara.evm));	
+			memset(g_struCalPara.evm,0,sizeof(g_struCalPara.evm));
 			memset(g_struCalPara.c_rssi_reg,0,sizeof(g_struCalPara.c_rssi_reg));
 #ifdef DEAL_DATA_HW
 			if(is_agc_mode) {
-				close_pa();		
-				CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable			
+				close_pa();
+				CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
 				if(g_localbw == 40) {
 					rf9808_change_chbw(80, 1,g_localchild);
 				}else if(g_localbw == 20)
-				{				
+				{
 					rf9808_change_chbw(40, 1,g_localchild);
 				}
-				mdelay(5);	
+				mdelay(5);
 				CAL_NST_IO_WRITE32(0x290,0x9860);
 				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0f00,0x0);//tx open
 				CAL_NST_IO_WRITE32(0x0,0x01000202);
@@ -607,7 +601,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 						if(!four_ant_enable) {
 							CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0,0x13c01f87);//open only one rf
 						}else
-						{					
+						{
 							CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0,0x13c01f9f);//open only one rf
 						}
 						CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x4,0xf0f0f00f);//open only rx
@@ -618,7 +612,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				}
 				UINT32 BW_SET= CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xFF8);
 				if (g_localbw == 80) {
-					CAL_NST_IO_WRITE32(0x29c,0x80009858);//??					
+					CAL_NST_IO_WRITE32(0x29c,0x80009858);//??
 					BW_SET &= (~0x3);
 					BW_SET |= 0x2;
 				}else if(g_localbw == 40) {
@@ -629,11 +623,11 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 					CAL_NST_IO_WRITE32(0x29c,0x8003e6d0);
 					BW_SET &= (~0x3);
 				}
-				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xFF8,BW_SET);    			
+				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xFF8,BW_SET);
 				UINT32 open_rx= CAL_NST_IO_READ32(0x294);
-				open_rx &= (~0x1);		
-				CAL_NST_IO_WRITE32(0x294,open_rx); //rx mode		 			
-				CAL_NST_IO_WRITE32(0xC, 0x80000007);	
+				open_rx &= (~0x1);
+				CAL_NST_IO_WRITE32(0x294,open_rx); //rx mode
+				CAL_NST_IO_WRITE32(0xC, 0x80000007);
 			}else {
 				UINT8 Mask_rf = parg->Mask_rf;
 				UINT32 Mask_rf_0_1 ,Mask_rf_2_3,REG0;
@@ -644,7 +638,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				REG0 &= ~(0xf<<16);//π§◊˜ÃÏœﬂ≈‰÷√,bit[16-19]
 				REG0 &= ~(3<<8);//π§◊˜¥¯øÌbit[8,9]
 				REG0 |= 2;//rx mode
-				Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04); 		
+				Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 				Mask_rf_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 				Mask_rf_0_1 &= (~0xFF);
 				Mask_rf_0_1 &= (~(0xFF<<16));
@@ -672,22 +666,22 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				CAL_NST_IO_WRITE32(0x2c4,0x1e);
 				CAL_NST_IO_WRITE32(0x2cc,0x0);
 				UINT32 open_rx= CAL_NST_IO_READ32(0x294);
-				open_rx &= (~0x1);		
-				CAL_NST_IO_WRITE32(0x294,open_rx); //rx mode	
+				open_rx &= (~0x1);
+				CAL_NST_IO_WRITE32(0x294,open_rx); //rx mode
 				#endif
 				if(g_localbw == 80) {
 					REG0 |= (2<<8);
-					CAL_NST_IO_WRITE32(0x29c,0x6a5d023); 
+					CAL_NST_IO_WRITE32(0x29c,0x6a5d023);
 				}else if(g_localbw == 40) {
 					REG0 |= (1<<8);
-					CAL_NST_IO_WRITE32(0x29c,0x665d023); 
+					CAL_NST_IO_WRITE32(0x29c,0x665d023);
 				}else if(g_localbw == 20) {
 					REG0 |= (0<<8);
-					CAL_NST_IO_WRITE32(0x29c,0x625d023); 
+					CAL_NST_IO_WRITE32(0x29c,0x625d023);
 				}
-				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF00,REG0); 
-				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF04,Mask_rf_0_1); 
-				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF08,Mask_rf_2_3); 
+				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF00,REG0);
+				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF04,Mask_rf_0_1);
+				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xF08,Mask_rf_2_3);
 				CAL_NST_IO_WRITE32(0xC, 0x80000007);
 				printk("phyf00:%x,phyf04:%x,phyf08:%x",REG0,Mask_rf_0_1,Mask_rf_2_3);
 			}
@@ -697,10 +691,10 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 		}
 		case IOCTRL_MEASURE_STOP:
 		{
-			g_struCalPara.b_Meas_stop =1;	
+			g_struCalPara.b_Meas_stop =1;
 			#ifdef DEAL_DATA_HW
 			close_pa();
-			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable	
+			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
 			g_struCalPara.ui_CorDataFramNum = 0;
 			#endif
 			printk("Measure Stop\r\n");
@@ -711,18 +705,18 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 #if 1
 			CalSelectAnt(parg->Mask_ant);
 			printk("select Ant mask:0x%x\r\n",parg->Mask_ant);
-			//rf_spi_write(0x17df, 2); 
+			//rf_spi_write(0x17df, 2);
 			//printk("RF_CW2:0x17df\n");
 #endif
 			break;
 		}
 		case IOCTRL_SELECT_RF:
-		{	
+		{
 			#ifndef DEAL_DATA_HW
 			RegPhy0Value = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0);
 			closeAllRF = RegPhy0Value & 0xFFFFFFE1;
 			selectRfenable = closeAllRF |(parg->Mask_rf<<1);
-			CAL_NST_IO_WRITE32((STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0), selectRfenable);			
+			CAL_NST_IO_WRITE32((STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0), selectRfenable);
 			printk("select RF mask:0x%x,PhyReg0:0x%08x\r\n",parg->Mask_rf,CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0));
 			#else
 			printk("nothing  \r\n");
@@ -732,7 +726,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 		case IOCTRL_RXREG:
 		{
 			int i = 0;
-			if(is_agc_mode) {						
+			if(is_agc_mode) {
 				LnaValue =	CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x18);  //AGC∏ﬂ÷–µÕ»˝µ≤≥ı º‘ˆ“Ê
 				LnaValue = LnaValue&0xFF000000; // «Â¿ÌLna ∏ﬂ÷–µÕµµ÷µ£¨±„”⁄≤‚¡ø◊º»∑
 				CAL_NST_IO_WRITE32((STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x18), LnaValue);
@@ -747,7 +741,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 						LnaValue =	CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x98);  //AGC∏ﬂ÷–µÕ»˝µ≤≥ı º‘ˆ“Ê
 						LnaValue = LnaValue&0xFF000000; // «Â¿ÌLna ∏ﬂ÷–µÕµµ÷µ£¨±„”⁄≤‚¡ø◊º»∑
 						CAL_NST_IO_WRITE32((STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x98), LnaValue);
-					}				
+					}
 				}
 				for(i = 0; i< 4; i++) {
 					if(parg->RxReg & (0xff << i*8)) {
@@ -759,7 +753,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			}else {
 				UINT8 *Rx_Reg = (UINT8 *)(&parg->RxReg);
 				UINT32 Rx_0_1 = 0,Rx_2_3 = 0;
-				Rx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+				Rx_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 				Rx_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 				Rx_0_1 &= (~(0xFF<<8));
 				Rx_0_1 &= (~(0xFF<<24));
@@ -769,7 +763,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				Rx_0_1 |= (Rx_Reg[1] << 24);
 				Rx_2_3 |= (Rx_Reg[2] <<8);
 				Rx_2_3 |= (Rx_Reg[3] << 24);
-				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Rx_0_1);			
+				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Rx_0_1);
 				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Rx_2_3);
 			}
 			printk("Reg:0x%x\r\n",parg->RxReg);
@@ -780,27 +774,27 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			parg->ReadFashResult = CalReadFlash();
 			g_readFlashOK = parg->ReadFashResult;
 			if(parg->ReadFashResult)
-			{			
+			{
 				adjust_localCalTable_value();
 			}
 			break;
 		}
 		case IOCTRL_SET_MCS://mcs 1 ,9
 		{
-			UINT32 Value;			
+			UINT32 Value;
 			close_pa();//close tx,protect pa
-			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable		
+			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
 			Value= CAL_NST_IO_READ32(0x294);
 			Value &= 0xFFFFFFFD;//bit 1,0 means mcs 1,1 means mcs 9
 			if(parg->mcs == 1)
 			{
 				cal_mcs = parg->mcs;
 				CAL_NST_IO_WRITE32(0x294, Value);
-					
+
 			}else if(parg->mcs == 9)
 			{
 				cal_mcs = parg->mcs;
-				Value |= 0x2;			
+				Value |= 0x2;
 				CAL_NST_IO_WRITE32(0x294, Value);
 			}else
 			{
@@ -811,10 +805,10 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 		}
 		case IOCTRL_SET_TX_FRAME_NUM:
 		{
-			UINT32 Value = 0,i = 0;				
+			UINT32 Value = 0,i = 0;
 			close_pa();//close tx,protect pa
-			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable			
-			Value= CAL_NST_IO_READ32(0x294); 		
+			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
+			Value= CAL_NST_IO_READ32(0x294);
 			Value &= 0xFFFFFE0F;//bit[4-8]
 			if(parg->framenum == 0)
 			{
@@ -822,7 +816,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				printk("always send\n");
 			}else
 			{
-				for(i = 0; (1<<i) < parg->framenum; i++);             
+				for(i = 0; (1<<i) < parg->framenum; i++);
 				printk("send frame num is %u \n",1<<i);
 				Value |= (i<<4);
 			}
@@ -831,14 +825,21 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 		}
 		case IOCTRL_TXSTART:
 		{
-			
+
 			UINT32 Mask_rf_0_1 = 0,Mask_rf_2_3 = 0;
 			g_struCalPara.IntTx = 0;
 			g_struCalPara.ui_SendPadNum = 0;
+			memset(parg->evm,0,sizeof(parg->evm));
+			parg->SNR0 = 0;
+			parg->RegRssi[0] = 0xba;
+			parg->RegRssi[1] = 0xba;
+			parg->RegRssi[2] = 0xba;
+			parg->RegRssi[3] = 0xba;
+			parg->rssi_float = 0;
 			close_pa();//close tx,protect pa
 			CAL_NST_IO_WRITE32(0xC, 0x80000006);//phy worken disable
 			UINT8 Mask_rf = parg->Mask_rf;
-			Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);			
+			Mask_rf_0_1 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04);
 			Mask_rf_2_3 = CAL_NST_IO_READ32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08);
 			Mask_rf_0_1 &= (~0xFF);
 			Mask_rf_0_1 &= (~(0xFF<<16));
@@ -859,7 +860,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				Mask_rf_0_1 |= (0x0b << 16);
 				Mask_rf_2_3 |= (0x0b);
 				Mask_rf_2_3 |= (0x0b << 16);
-				
+
 			}
 			printk("select RF_01 mask:0x%x,RF_23:0x%x\r\n",Mask_rf_0_1,Mask_rf_2_3);
 			if(four_ant_enable)
@@ -870,7 +871,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			    CAL_NST_IO_WRITE32(0x0,0x01000602);
 				CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0x0,0x13c01f87);
 			}
-			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE + 0xf00, 0xff0f0201);	
+			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE + 0xf00, 0xff0f0201);
 			UINT32 Value_294 = CAL_NST_IO_READ32(0x294);
 			Value_294 |= 0x7;// start tx  bit[0]:statr tx ,bit[2]:data is signed
 			Value_294 &= (~0xC00);
@@ -880,27 +881,34 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				//CAL_NST_IO_WRITE32(0x290,0x6100C65C);// down:up = 1:1
 			}else if(g_localbw == 40)
 			{
-				CAL_NST_IO_WRITE32(0x290,0x61030300);              
+				CAL_NST_IO_WRITE32(0x290,0x61030300);
 				Value_294 |= 0x800;
 			}else if(g_localbw == 20)
 			{
-				CAL_NST_IO_WRITE32(0x290,0x6104e6d0); 
+				CAL_NST_IO_WRITE32(0x290,0x6104e6d0);
 				Value_294 |= 0x400;
 			}
-			CAL_NST_IO_WRITE32(0x294, Value_294); 
+			CAL_NST_IO_WRITE32(0x294, Value_294);
 			printk("ready to open\n");
 			CAL_NST_IO_WRITE32(0xC, 0x40000007);//phy worken enable
-			g_struCalPara.IntTx = 0;	
-			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Mask_rf_0_1);			
-			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Mask_rf_2_3);		
-			CAL_NST_IO_WRITE32(0x298,0x6868);//for plus		
+			g_struCalPara.IntTx = 0;
+			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf04,Mask_rf_0_1);
+			CAL_NST_IO_WRITE32(STA_PHY_REG_BASE_ADDR_OFFSET_CALUSE+0xf08,Mask_rf_2_3);
+
+			if(rf_ant_num == 4) {
+				CAL_NST_IO_WRITE32(0x298,0x3434);//for 4ant
+			}else if (rf_ant_num == 2) {
+				CAL_NST_IO_WRITE32(0x298,0x4a4a);//for 2ant
+			}else if(rf_ant_num == 1) {
+				CAL_NST_IO_WRITE32(0x298,0x6868);//for 1ant
+			}
 			break;
 		}
 		case IOCTRL_WRITE_REG:
-		{		
+		{
 			CAL_NST_IO_WRITE32(parg->Reg, parg->Reg_Value);
 			if(write_count < 10) {
-				printk("first:Reg:%x,Reg_Value:%x\n",parg->Reg,parg->Reg_Value);				
+				printk("first:Reg:%x,Reg_Value:%x\n",parg->Reg,parg->Reg_Value);
 			}
 			write_count++;
 			break;
@@ -914,7 +922,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 			int i = 0;
 			for(i = 0; i < 6; i++) {
 				atten %= (1<<(5-i));
-				if(last_atten > atten){				
+				if(last_atten > atten){
 					reg |= 1 << (5 - i);
 					last_atten = atten;
 				}
@@ -926,7 +934,7 @@ static 	long  nufront_dbg_unlocked_ioctl(struct file *filp, unsigned int cmd, un
 				printk("atten input error:%u\n",atten);
 			}else {
 				reg_val =  (~reg)&0x3f;
-				printk("reg = 0x%x\n",reg_val);	
+				printk("reg = 0x%x\n",reg_val);
 				CAL_NST_IO_WRITE32(0x2ac,reg_val);
 			}
 			break;
@@ -948,9 +956,9 @@ out:
 	return err;
 }
 static int mem_mmap(struct file *file, struct vm_area_struct *vma)
-{	
-	vma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);	
-	remap_pfn_range(vma, vma->vm_start, 0x40000000 >> 12, vma->vm_end-vma->vm_start, vma->vm_page_prot);	
+{
+	vma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);
+	remap_pfn_range(vma, vma->vm_start, 0x40000000 >> 12, vma->vm_end-vma->vm_start, vma->vm_page_prot);
 	return 0;
 }
 
@@ -992,9 +1000,9 @@ static __init nufront_debug_init(void)
 		printk("%s : register the nufront misc device failed\n",__func__);
 		goto err_misc_failed;
 	}
-    
+
 	return 0;
-    
+
 err_misc_failed:
 
 	 return err;
@@ -1005,7 +1013,7 @@ err_misc_failed:
 	int regvalue = 0;
 
 	regvalue=ReadFlash();
-	return regvalue;	    
+	return regvalue;
 }
 
 static __exit nufront_dbg_exit(void)
